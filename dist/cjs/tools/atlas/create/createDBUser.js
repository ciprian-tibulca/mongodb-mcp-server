"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CreateDBUserTool = exports.CreateDBUserArgs = void 0;
const zod_1 = require("zod");
const atlasTool_js_1 = require("../atlasTool.js");
const generatePassword_js_1 = require("../../../helpers/generatePassword.js");
const accessListUtils_js_1 = require("../../../common/atlas/accessListUtils.js");
const args_js_1 = require("../../args.js");
exports.CreateDBUserArgs = {
    projectId: args_js_1.AtlasArgs.projectId().describe("Atlas project ID"),
    username: args_js_1.AtlasArgs.username().describe("Username for the new user"),
    // Models will generate overly simplistic passwords like SecurePassword123 or
    // AtlasPassword123, which are easily guessable and exploitable. We're instructing
    // the model not to try and generate anything and instead leave the field unset.
    password: args_js_1.AtlasArgs.password()
        .nullish()
        .describe("Password for the new user. IMPORTANT: If the user hasn't supplied an explicit password, leave it unset and under no circumstances try to generate a random one. A secure password will be generated by the MCP server if necessary."),
    roles: zod_1.z
        .array(zod_1.z.object({
        roleName: args_js_1.CommonArgs.string().describe("Role name"),
        databaseName: args_js_1.CommonArgs.string().describe("Database name").default("admin"),
        collectionName: args_js_1.CommonArgs.string().describe("Collection name").optional(),
    }))
        .describe("Roles for the new user"),
    clusters: zod_1.z
        .array(args_js_1.AtlasArgs.clusterName())
        .describe("Clusters to assign the user to, leave empty for access to all clusters")
        .optional(),
};
class CreateDBUserTool extends atlasTool_js_1.AtlasToolBase {
    constructor() {
        super(...arguments);
        this.name = "atlas-create-db-user";
        this.description = "Create an MongoDB Atlas database user";
        this.argsShape = {
            ...exports.CreateDBUserArgs,
        };
    }
    async execute({ projectId, username, password, roles, clusters, }) {
        await (0, accessListUtils_js_1.ensureCurrentIpInAccessList)(this.session.apiClient, projectId);
        const shouldGeneratePassword = !password;
        if (shouldGeneratePassword) {
            password = await (0, generatePassword_js_1.generateSecurePassword)();
        }
        const input = {
            groupId: projectId,
            awsIAMType: "NONE",
            databaseName: "admin",
            ldapAuthType: "NONE",
            oidcAuthType: "NONE",
            x509Type: "NONE",
            username,
            password,
            roles: roles,
            scopes: clusters?.length
                ? clusters.map((cluster) => ({
                    type: "CLUSTER",
                    name: cluster,
                }))
                : undefined,
        };
        await this.session.apiClient.createDatabaseUser({
            params: {
                path: {
                    groupId: projectId,
                },
            },
            body: input,
        });
        this.session.keychain.register(username, "user");
        if (password) {
            this.session.keychain.register(password, "password");
        }
        return {
            content: [
                {
                    type: "text",
                    text: `User "${username}" created successfully${shouldGeneratePassword ? ` with password: \`${password}\`` : ""}.`,
                },
            ],
        };
    }
    getConfirmationMessage({ projectId, username, password, roles, clusters, }) {
        return (`You are about to create a database user in Atlas project \`${projectId}\`:\n\n` +
            `**Username**: \`${username}\`\n\n` +
            `**Password**: ${password ? "(User-provided password)" : "(Auto-generated secure password)"}\n\n` +
            `**Roles**: ${roles.map((role) => `${role.roleName}${role.collectionName ? ` on ${role.databaseName}.${role.collectionName}` : ` on ${role.databaseName}`}`).join(", ")}\n\n` +
            `**Cluster Access**: ${clusters?.length ? clusters.join(", ") : "All clusters in the project"}\n\n` +
            "This will create a new database user with the specified permissions. " +
            "**Do you confirm the execution of the action?**");
    }
}
exports.CreateDBUserTool = CreateDBUserTool;
CreateDBUserTool.operationType = "create";
//# sourceMappingURL=createDBUser.js.map